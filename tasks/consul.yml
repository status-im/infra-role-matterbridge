---
- name: Create Consul service definition
  include_role: name=infra-role-consul-service
  vars:
    consul_config_name: '{{ matterbridge_service_name }}'
    consul_services:
      - name: '{{ matterbridge_service_name }}'
        tags: ['matterbridge', 'bridge']
        checks:
          - id: '{{ matterbridge_service_name }}-health'
            name: 'MatterBridge health'
            type: 'script'
            script: '/usr/bin/pgrep -xl matterbridge'

- name: Create Consul service definition for API
  include_role: name=infra-role-consul-service
  when: '{{ matterbridge_api_enabled }}'
  vars:
    consul_config_name: '{{ matterbridge_service_name }}-api'
    consul_services:
      - name: '{{ matterbridge_service_name }}-api'
        tags: ['matterbridge', 'bridge']
        checks:
          - id: '{{ matterbridge_service_name }}-api-health'
            name: 'MatterBridge API health'
            type: 'http'
            http: 'http://localhost:{{ matterbridge_api_port }}/api/health'
